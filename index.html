<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Українські переклади модів</title>
    <link rel="icon" href="data:,">
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f4f4f4;
            color: #333;
        }
        h1 {
            text-align: center;
        }
        #search-container {
            text-align: center;
            margin-bottom: 20px;
        }
        #search-input, select {
            padding: 10px;
            font-size: 16px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin: 0 5px 10px 0;
        }
        #search-input {
            width: 300px;
        }
        .mod-list {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
        }
        .mod-card {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            margin: 10px;
            padding: 15px;
            width: 220px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .mod-card img {
            width: 66.67%;
            height: auto;
            border-radius: 4px;
            display: block;
            margin: 0 auto;
        }
        .mod-card h2 {
            margin: 10px 0;
        }
        .mod-card p {
            margin: 5px 0;
        }
        .version-list {
            margin-top: 10px;
        }
        .version-item {
            margin-bottom: 10px;
        }
        button {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 10px 15px;
            cursor: pointer;
            border-radius: 4px;
            margin-top: 5px;
        }
        button:hover {
            background-color: #45a049;
        }
        #combine-open {
            position: fixed;
            top: 10px;
            right: 10px;
            z-index: 1000;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
            padding-top: 60px;
        }
        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 600px;
            border-radius: 8px;
        }
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }
        .close:hover,
        .close:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
        #select-list div {
            margin-bottom: 15px;
            border-bottom: 1px solid #ddd;
            padding-bottom: 10px;
        }
        .hidden {
            display: none;
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
</head>
<body>
    <h1>Українські переклади модів (як Modrinth)</h1>
    <div id="search-container">
        <input type="text" id="search-input" placeholder="Пошук по назві мода..."><br>
        <select id="filter-version">
            <option value="">Всі версії</option>
        </select>
        <select id="filter-core">
            <option value="">Всі ядра</option>
        </select>
        <select id="filter-author">
            <option value="">Всі автори</option>
        </select>
    </div>
    <button id="combine-open">Об'єднати мод</button>
    <div id="mod-list" class="mod-list"></div>
    
    <div id="combine-modal" class="modal">
        <div class="modal-content">
            <span class="close combine-close">&times;</span>
            <h2>Об'єднати мод і переклад</h2>
            <p>Завантажте мод (.jar) і переклад (uk_ua.json), сайт об'єднає їх і завантажить оновлений мод.</p>
            <input type="file" id="mod-file" accept=".jar">
            <input type="file" id="json-file" accept=".json">
            <button onclick="combineFiles()">Об'єднати та завантажити</button>
        </div>
    </div>

    <div id="select-modal" class="modal">
        <div class="modal-content">
            <span class="close select-close">&times;</span>
            <h2>Вибрати переклад</h2>
            <div id="select-list"></div>
        </div>
    </div>

    <script>
        const repoOwner = 'halitflyn';
        const repoName = 'ua';
        const basePath = 'mods';
        const rawBaseUrl = `https://raw.githubusercontent.com/${repoOwner}/${repoName}/main`;

        // Масиви для фільтрів
        let allVersions = new Set();
        let allCores = new Set();
        let allAuthors = new Set();

        async function fetchRepoContents(path) {
            const url = `https://api.github.com/repos/${repoOwner}/${repoName}/contents/${path}`;
            try {
                const response = await fetch(url);
                if (!response.ok) {
                    return null;
                }
                return await response.json();
            } catch (e) {
                console.error(`Error fetching contents for ${path}:`, e);
                return null;
            }
        }

        async function loadMods() {
            const mods = await fetchRepoContents(basePath);
            if (!mods || !Array.isArray(mods)) return;

            const modListDiv = document.getElementById('mod-list');

            for (const mod of mods) {
                if (mod.type !== 'dir') continue;

                const modPath = `${basePath}/${mod.name}`;
                const modContents = await fetchRepoContents(modPath);
                if (!modContents || !Array.isArray(modContents)) continue;

                let modJson = null;
                let modTxt = null;
                let imageUrl = null;
                let langFiles = [];

                for (const file of modContents) {
                    if (file.name === 'mod.json') {
                        try {
                            const jsonResponse = await fetch(`${rawBaseUrl}/${modPath}/mod.json`);
                            if (jsonResponse.ok) {
                                modJson = await jsonResponse.json();
                                if (!Array.isArray(modJson)) modJson = null;
                            }
                        } catch (e) {
                            console.error(`Error fetching mod.json for ${mod.name}:`, e);
                        }
                    } else if (file.name === 'mod.txt') {
                        try {
                            const txtResponse = await fetch(`${rawBaseUrl}/${modPath}/mod.txt`);
                            if (txtResponse.ok) {
                                modTxt = await txtResponse.text();
                            }
                        } catch (e) {
                            console.error(`Error fetching mod.txt for ${mod.name}:`, e);
                        }
                    } else if (file.name === 'image.jpeg') {
                        imageUrl = `${rawBaseUrl}/${modPath}/image.jpeg`;
                    } else if (file.name === 'lang' && file.type === 'dir') {
                        const langPath = `${modPath}/lang`;
                        const langContents = await fetchRepoContents(langPath);
                        if (langContents && Array.isArray(langContents)) {
                            langFiles = langContents.map(f => ({
                                author: f.name.replace('.json', ''),
                                url: `${rawBaseUrl}/${langPath}/${f.name}`
                            }));
                        }
                    }
                }

                if (modJson && modTxt && imageUrl) {
                    const [name, description, modrinthLink] = modTxt.trim().split('\n');

                    // Aggregate versions and loaders
                    const allVersionsArr = modJson.map(v => v.version).sort((a, b) => {
                        const aParts = a.split('.').map(Number);
                        const bParts = b.split('.').map(Number);
                        for (let i = 0; i < Math.max(aParts.length, bParts.length); i++) {
                            if ((aParts[i] || 0) !== (bParts[i] || 0)) {
                                return (aParts[i] || 0) - (bParts[i] || 0);
                            }
                        }
                        return 0;
                    });
                    const uniqueVersions = [...new Set(allVersionsArr)];
                    const minVersion = uniqueVersions[0];
                    const maxVersion = uniqueVersions[uniqueVersions.length - 1];
                    const versionText = minVersion === maxVersion ? minVersion : `${minVersion}-${maxVersion}`;

                    const allLoadersArr = modJson.map(v => v.loader);
                    const uniqueLoaders = [...new Set(allLoadersArr)];
                    const loadersDisplay = uniqueLoaders.join(' - ');

                    const allAuthorsArr = modJson.map(v => v.author);

                    // Додати у множини для фільтрів
                    allVersionsArr.forEach(v => allVersions.add(v));
                    allLoadersArr.forEach(l => allCores.add(l));
                    allAuthorsArr.forEach(a => allAuthors.add(a));

                    const card = document.createElement('div');
                    card.className = 'mod-card';
                    card.dataset.name = name.toLowerCase();
                    card.dataset.versions = allVersionsArr.join(' ').toLowerCase();
                    card.dataset.loaders = uniqueLoaders.join(' ').toLowerCase();
                    card.dataset.authors = allAuthorsArr.join(' ').toLowerCase();
                    card.innerHTML = `
                        <img src="${imageUrl}" alt="${name}">
                        <h2>${name}</h2>
                        <p>${description}</p>
                        <p><a href="${modrinthLink}" target="_blank">Modrinth сторінка</a></p>
                        <p>Версія: ${versionText}</p>
                        <p>(${loadersDisplay})</p>
                    `;
                    const selectButton = document.createElement('button');
                    selectButton.textContent = 'Вибрати переклад';
                    selectButton.addEventListener('click', () => showSelectModal(modJson, langFiles, name));
                    card.appendChild(selectButton);

                    modListDiv.appendChild(card);
                }
            }

            // Заповнити фільтри
            populateFilterOptions();
        }

        // Заповнити фільтри
        function populateFilterOptions() {
            const vSelect = document.getElementById('filter-version');
            const cSelect = document.getElementById('filter-core');
            const aSelect = document.getElementById('filter-author');

            [...allVersions].sort().forEach(v => {
                const opt = document.createElement('option');
                opt.value = v;
                opt.textContent = v;
                vSelect.appendChild(opt);
            });
            [...allCores].sort().forEach(c => {
                const opt = document.createElement('option');
                opt.value = c;
                opt.textContent = c;
                cSelect.appendChild(opt);
            });
            [...allAuthors].sort().forEach(a => {
                const opt = document.createElement('option');
                opt.value = a;
                opt.textContent = a;
                aSelect.appendChild(opt);
            });
        }

        function showSelectModal(modJson, langFiles, modName) {
            const modal = document.getElementById('select-modal');
            const list = document.getElementById('select-list');
            list.innerHTML = '';
            let hasItems = false;
            modJson.forEach(version => {
                const langFile = langFiles.find(l => l.author.toLowerCase() === version.author.toLowerCase());
                if (langFile) {
                    hasItems = true;
                    const item = document.createElement('div');
                    item.innerHTML = `
                        <p>Версія: ${version.version} (${version.loader})</p>
                        <p>Автор: ${version.author}</p>
                    `;
                    const downloadButton = document.createElement('button');
                    downloadButton.textContent = 'Завантажити';
                    downloadButton.addEventListener('click', () => downloadBoth(version.link, langFile.url, modName));
                    item.appendChild(downloadButton);
                    list.appendChild(item);
                }
            });
            if (!hasItems) {
                list.innerHTML = '<p>Немає доступних перекладів.</p>';
            }
            modal.style.display = 'block';
        }

        async function downloadBoth(jarUrl, jsonUrl, modName) {
            // Download JAR
            const jarFilename = jarUrl.split('/').pop();
            const jarLink = document.createElement('a');
            jarLink.href = jarUrl;
            jarLink.download = jarFilename;
            document.body.appendChild(jarLink);
            jarLink.click();
            document.body.removeChild(jarLink);

            // Download JSON
            try {
                const response = await fetch(jsonUrl);
                if (!response.ok) {
                    throw new Error('Переклад не знайдено');
                }
                const blob = await response.blob();
                const jsonLink = document.createElement('a');
                jsonLink.href = URL.createObjectURL(blob);
                jsonLink.download = 'uk_ua.json';
                document.body.appendChild(jsonLink);
                jsonLink.click();
                document.body.removeChild(jsonLink);
                URL.revokeObjectURL(jsonLink.href);
            } catch (e) {
                alert('Помилка завантаження перекладу: ' + e.message);
            }
        }

        async function combineFiles() {
            const modFile = document.getElementById('mod-file').files[0];
            const jsonFile = document.getElementById('json-file').files[0];

            if (!modFile || !jsonFile) {
                alert('Будь ласка, завантажте обидва файли.');
                return;
            }

            const zip = new JSZip();
            const modArrayBuffer = await modFile.arrayBuffer();
            await zip.loadAsync(modArrayBuffer);

            const jsonContent = await jsonFile.text();

            let modid = 'unknown';
            const modFiles = Object.keys(zip.files);

            // Check for Forge mods.toml
            if (zip.file('META-INF/mods.toml')) {
                const tomlContent = await zip.file('META-INF/mods.toml').async('string');
                const modidMatch = tomlContent.match(/modId\s*=\s*"([^"]+)"/);
                if (modidMatch) modid = modidMatch[1];
            } else if (zip.file('fabric.mod.json')) {
                // Fabric/Quilt
                const jsonContent = await zip.file('fabric.mod.json').async('string');
                const modMeta = JSON.parse(jsonContent);
                modid = modMeta.id;
            }

            if (modid !== 'unknown') {
                const langPath = `assets/${modid}/lang/uk_ua.json`;
                zip.file(langPath, jsonContent);
            } else {
                alert('Не вдалося визначити modid. Додайте вручну.');
                return;
            }

            const newZipBlob = await zip.generateAsync({type: 'blob'});
            const url = URL.createObjectURL(newZipBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = modFile.name.replace('.jar', '_translated.jar');
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        // Modal controls
        const combineModal = document.getElementById('combine-modal');
        const selectModal = document.getElementById('select-modal');
        const combineOpen = document.getElementById('combine-open');
        const combineClose = document.querySelector('.combine-close');
        const selectClose = document.querySelector('.select-close');

        combineOpen.onclick = () => { combineModal.style.display = 'block'; };
        combineClose.onclick = () => { combineModal.style.display = 'none'; };
        selectClose.onclick = () => { selectModal.style.display = 'none'; };

        window.onclick = (event) => {
            if (event.target === combineModal) combineModal.style.display = 'none';
            if (event.target === selectModal) selectModal.style.display = 'none';
        };

        // Фільтрація + пошук по назві
        function filterMods() {
            const search = document.getElementById('search-input').value.toLowerCase();
            const versionFilter = document.getElementById('filter-version').value.toLowerCase();
            const coreFilter = document.getElementById('filter-core').value.toLowerCase();
            const authorFilter = document.getElementById('filter-author').value.toLowerCase();

            document.querySelectorAll('.mod-card').forEach(card => {
                const name = card.dataset.name;
                const versions = card.dataset.versions;
                const loaders = card.dataset.loaders;
                const authors = card.dataset.authors;

                const hasName = name.includes(search);
                const hasVersion = versionFilter === '' || versions.includes(versionFilter);
                const hasLoader = coreFilter === '' || loaders.includes(coreFilter);
                const hasAuthor = authorFilter === '' || authors.includes(authorFilter);

                if (hasName && hasVersion && hasLoader && hasAuthor) {
                    card.classList.remove('hidden');
                } else {
                    card.classList.add('hidden');
                }
            });
        }

        loadMods().then(() => {
            document.getElementById('search-input').addEventListener('input', filterMods);
            document.getElementById('filter-version').addEventListener('change', filterMods);
            document.getElementById('filter-core').addEventListener('change', filterMods);
            document.getElementById('filter-author').addEventListener('change', filterMods);
        });
    </script>
</body>
</html>
