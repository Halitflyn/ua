<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Українські переклади модів</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f4f4f4;
            color: #333;
        }
        h1 {
            text-align: center;
        }
        .mod-list {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
        }
        .mod-card {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            margin: 10px;
            padding: 15px;
            width: 300px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .mod-card img {
            width: 100%;
            height: auto;
            border-radius: 4px;
        }
        .mod-card h2 {
            margin: 10px 0;
        }
        .mod-card p {
            margin: 5px 0;
        }
        .version-list {
            margin-top: 10px;
        }
        .version-item {
            margin-bottom: 10px;
        }
        button {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 10px 15px;
            cursor: pointer;
            border-radius: 4px;
            margin-top: 5px;
        }
        button:hover {
            background-color: #45a049;
        }
        #combine-tab {
            margin-top: 40px;
            text-align: center;
        }
        #combine-tab input {
            margin: 10px;
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
</head>
<body>
    <h1>Українські переклади модів (як Modrinth)</h1>
    <div id="mod-list" class="mod-list"></div>
    
    <div id="combine-tab">
        <h2>Об'єднати мод і переклад</h2>
        <p>Завантажте мод (.jar) і переклад (uk_ua.json), сайт об'єднає їх і завантажить оновлений мод.</p>
        <input type="file" id="mod-file" accept=".jar">
        <input type="file" id="json-file" accept=".json">
        <button onclick="combineFiles()">Об'єднати та завантажити</button>
    </div>

    <script>
        const repoOwner = 'halitflyn';
        const repoName = 'ua';
        const basePath = 'mods';
        const rawBaseUrl = `https://raw.githubusercontent.com/${repoOwner}/${repoName}/main`;

        async function fetchRepoContents(path) {
            const url = `https://api.github.com/repos/${repoOwner}/${repoName}/contents/${path}`;
            try {
                const response = await fetch(url);
                if (!response.ok) {
                    return null;
                }
                return await response.json();
            } catch (e) {
                console.error(`Error fetching contents for ${path}:`, e);
                return null;
            }
        }

        async function loadMods() {
            const mods = await fetchRepoContents(basePath);
            if (!mods || !Array.isArray(mods)) return;

            const modListDiv = document.getElementById('mod-list');

            for (const mod of mods) {
                if (mod.type !== 'dir') continue;

                const modPath = `${basePath}/${mod.name}`;
                const modContents = await fetchRepoContents(modPath);
                if (!modContents || !Array.isArray(modContents)) continue;

                let modJson = null;
                let modTxt = null;
                let imageUrl = null;
                let langFiles = [];

                for (const file of modContents) {
                    if (file.name === 'mod.json') {
                        try {
                            const jsonResponse = await fetch(`${rawBaseUrl}/${modPath}/mod.json`);
                            if (jsonResponse.ok) {
                                modJson = await jsonResponse.json();
                                if (!Array.isArray(modJson)) modJson = null;
                            }
                        } catch (e) {
                            console.error(`Error fetching mod.json for ${mod.name}:`, e);
                        }
                    } else if (file.name === 'mod.txt') {
                        try {
                            const txtResponse = await fetch(`${rawBaseUrl}/${modPath}/mod.txt`);
                            if (txtResponse.ok) {
                                modTxt = await txtResponse.text();
                            }
                        } catch (e) {
                            console.error(`Error fetching mod.txt for ${mod.name}:`, e);
                        }
                    } else if (file.name === 'image.jpeg') {
                        imageUrl = `${rawBaseUrl}/${modPath}/image.jpeg`;
                    } else if (file.name === 'lang' && file.type === 'dir') {
                        const langPath = `${modPath}/lang`;
                        const langContents = await fetchRepoContents(langPath);
                        if (langContents && Array.isArray(langContents)) {
                            langFiles = langContents.map(f => ({
                                author: f.name.replace('.json', ''),
                                url: `${rawBaseUrl}/${langPath}/${f.name}`
                            }));
                        }
                    }
                }

                if (modJson && modTxt && imageUrl) {
                    const [name, description, modrinthLink] = modTxt.trim().split('\n');

                    const card = document.createElement('div');
                    card.className = 'mod-card';
                    card.innerHTML = `
                        <img src="${imageUrl}" alt="${name}">
                        <h2>${name}</h2>
                        <p>${description}</p>
                        <p><a href="${modrinthLink}" target="_blank">Modrinth сторінка</a></p>
                        <div class="version-list"></div>
                    `;

                    const versionList = card.querySelector('.version-list');
                    modJson.forEach(version => {
                        const langFile = langFiles.find(l => l.author.toLowerCase() === version.author.toLowerCase());
                        if (langFile) {
                            const versionItem = document.createElement('div');
                            versionItem.className = 'version-item';
                            versionItem.innerHTML = `
                                <p>Версія: ${version.version} (${version.loader}) - Автор перекладу: ${version.author}</p>
                                <button onclick="downloadBoth('${version.link}', '${langFile.url}', '${version.name}')">Завантажити мод + переклад</button>
                            `;
                            versionList.appendChild(versionItem);
                        }
                    });

                    if (versionList.children.length > 0) {
                        modListDiv.appendChild(card);
                    }
                }
            }
        }

        async function downloadBoth(jarUrl, jsonUrl, baseName) {
            // Download JAR directly
            const jarLink = document.createElement('a');
            jarLink.href = jarUrl;
            jarLink.download = baseName + '.jar';
            document.body.appendChild(jarLink);
            jarLink.click();
            document.body.removeChild(jarLink);

            // Download JSON with check
            try {
                const response = await fetch(jsonUrl);
                if (!response.ok) {
                    throw new Error('Переклад не знайдено');
                }
                const blob = await response.blob();
                const jsonLink = document.createElement('a');
                jsonLink.href = URL.createObjectURL(blob);
                jsonLink.download = 'uk_ua.json';
                document.body.appendChild(jsonLink);
                jsonLink.click();
                document.body.removeChild(jsonLink);
                URL.revokeObjectURL(jsonLink.href);
            } catch (e) {
                alert('Помилка завантаження перекладу: ' + e.message);
            }
        }

        async function combineFiles() {
            const modFile = document.getElementById('mod-file').files[0];
            const jsonFile = document.getElementById('json-file').files[0];

            if (!modFile || !jsonFile) {
                alert('Будь ласка, завантажте обидва файли.');
                return;
            }

            const zip = new JSZip();
            const modArrayBuffer = await modFile.arrayBuffer();
            await zip.loadAsync(modArrayBuffer);

            const jsonContent = await jsonFile.text();

            let modid = 'unknown';
            const modFiles = Object.keys(zip.files);

            // Check for Forge mods.toml
            if (zip.file('META-INF/mods.toml')) {
                const tomlContent = await zip.file('META-INF/mods.toml').async('string');
                const modidMatch = tomlContent.match(/modId\s*=\s*"([^"]+)"/);
                if (modidMatch) modid = modidMatch[1];
            } else if (zip.file('fabric.mod.json')) {
                // Fabric/Quilt
                const jsonContent = await zip.file('fabric.mod.json').async('string');
                const modMeta = JSON.parse(jsonContent);
                modid = modMeta.id;
            }

            if (modid !== 'unknown') {
                const langPath = `assets/${modid}/lang/uk_ua.json`;
                zip.file(langPath, jsonContent);
            } else {
                alert('Не вдалося визначити modid. Додайте вручну.');
                return;
            }

            const newZipBlob = await zip.generateAsync({type: 'blob'});
            const url = URL.createObjectURL(newZipBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = modFile.name.replace('.jar', '_translated.jar');
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        loadMods();
    </script>
</body>
</html>
